# Openaibot

OpenAI Chat Telegram Bot

[EN_README](https://github.com/sudoskys/Openaibot/blob/main/README.EN.md)

Writing with OpenAi on Telegram. Python > 3.7.

This program operates using `Api` authentication `Token` and is not an inverse of `chatGPT`, the **Python
implementation** of the chatGPT **function** is self-implemented by this bot.

```
This is not an official OpenAI product. This is a personal project and is not affiliated with OpenAI in any way. don't sue me
```

**Not responsible for any content generated by the bot, content provided by OpenAi**

**Implemented chatGPT myself, basically the same experience, except the Api costs money**

*Homebrew asynchronous dependency library*

## Features

* chat chatGpt self-implemented + NLP enhancements
* write independent speculation, continue writing
* Multi-host management
* Multi-Api key load, overrun popups.
* chatGPT api version implementation, not reverse preview's api
* Private chat support
* Support for group chats
* Support for rate limiting
* Support for usage management
* Whitelisting support
* Blacklisting support
* Support for content filtering
* (20221205) Dependency library does not support asynchronous, large number of requests will block, replace with own
  asynchronous library
* chatGpt replaced with own chatGpt Openai api Python implementation
* Dynamic context clipping

See https://github.com/sudoskys/Openaibot/issues/1

**chat**

🔭 Using `/chat + sentence` you can reset the AI's memory and then just `reply` to talk. Private chat messages or group
messages within 24 hours are automatically inferred and cropped using context, and the conversation can be continued by
replying directly.

Ai's memory bucket is reset each time `/chat` is used.

/write + sentence for continuation

**Continue writing**

🥖 Use `/write` to continue without contextual speculation.

**Head**

Supports persona settings, using `/remind` to design your own request headers.

## Initialisation

Server memory greater than 500MB, as NLP technical support context is used.

## Pull/update process

The install script automatically backs up the restored configuration, run it in the root directory (not in the program
directory)
If it is a minor update you can just ``git pull``.

```shell
curl -LO https://raw.githubusercontent.com/sudoskys/Openaibot/main/setup.sh && sh setup.sh
```

``cd Openaibot``

## Configure

### Configuring Redis

**local**

```shell
apt-get install redis
```

**Docker + persistence (saved in . /redis directory)**

```
docker run --name redis -d -v $(pwd)/redis:/data -p 6379:6379 redis redis-server --save 60 1 --loglevel warning
```

### Configure dependencies

```bash
pip install -r requirements.txt
```

``pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple``

### Filters

Data/Danger.form One line of one blacklisted vocabulary. There must be at least one.

If not, the program will automatically pull down the cloud default list, and subsequent updetects will pull the cloud to
overwrite the local one.

You can turn this filter off by placing a one-line list, but I don't favour you doing this.

### Config/app.toml

`cp app_exp.toml app.toml`

`vim app.toml`
`nano app.toml`

**configuration file**

```toml
[bot]
master = [555555, 66666] # master user id &account id
botToken = 'key'
INTRO = "POWER BY OPENAI" # suffix
ABOUT = "Created by github.com/sudoskys/Openaibot"
WHITE = "Group NOT in WHITE list"

# for bot , not openai
[proxy]
status = false
url = "http://127.0.0.1:7890"
```

[Telegram botToken request](https://t.me/BotFather)

**configure key**

```markdown
see_api_key - now several Api keys
del_api_key - remove Api key
add_api_key - add Api key
```

[OPENAI_API_KEY application](https://beta.openai.com/account/api-keys), support for multiple key distribution load
[Pricing Reference](https://openai.com/api/pricing/)

Please don't expose your `app.toml` to anyone

## Run

* Run

```shell
nohup python3 main.py > /dev/null 2>&1 & 
```

* View the process

```shell
ps -aux|grep python3
```

* Terminate a process
  followed by the process number

```shell
kill -9  
```

## command

Restricted class setting set to ``1`` means no effect.

| command                                   | function                    | extra                                                                                                                                       |
|-------------------------------------------|-----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| `/set_user_cold`                          | set user cooldown time      | can not send within the time 1 is unlimited                                                                                                 |
| `/set_group_cold`                         | Set group cooling time      | Cannot send within the time 1 is unlimited                                                                                                  |
| `/set_token_limit`                        | Set the output limit length | Api's 4095 limit is input + output, if it exceeds the limit, please reduce the output                                                       |
| `/set_input_limit`                        | Set input limit length      |                                                                                                                                             |
| `/config`                                 | get/backup config.json file | send file                                                                                                                                   |
| `/add_block_group` +id absolute value     | Prohibited                  | Effective directly Can be followed by multiple parameters, separated by spaces                                                              |
| `/del_block_group` + absolute value of id | Unban                       | Effective directly Can be separated with multiple parameters and spaces                                                                     |
| `/add_block_user` +Absolute value of id   | Forbidden                   | Effective directly Can be followed by multiple parameters, separated by spaces                                                              |
| `/del_block_user` + absolute value of id  | Unban                       | Effective directly Can be separated with multiple parameters and spaces                                                                     |
| `/add_white_group` +id absolute value     | Add                         | Need to enable the whitelist mode to take effect Can be separated with multiple parameters and spaces                                       |
| `/add_white_user` + id absolute value     | Add                         | Need to enable the whitelist mode to take effect Can be separated with multiple parameters and spaces                                       |
| `/del_white_group` +id absolute value     | Delisting                   | Need to enable the whitelist mode to take effect Can be separated with multiple parameters and spaces                                       |
| `/del_white_user` + absolute value of id  | Delisting                   | Need to enable the whitelist mode to take effect Can be separated with multiple parameters and spaces                                       |
| `/update_detect`                          | Update sensitive words      |                                                                                                                                             |
| `/open_user_white_mode`                   | Open user whitelist         |                                                                                                                                             |
| `/open_group_white_mode`                  | Open group whitelist        |                                                                                                                                             |
| `/close_user_white_mode`                  | close user whitelist        |                                                                                                                                             |
| `/close_group_white_mode`                 | close group whitelist       |                                                                                                                                             |
| `/open`                                   | Open the robot              |                                                                                                                                             |
| `/close`                                  | close the robot             |                                                                                                                                             |
| `/chat`                                   | Conversation                | Each time /chat starts over, forgetting the record. Replies cannot be indexed after 24 hours in the group, and private chats are permanent. |
| `/write`                                  | continue writing            | continue writing.                                                                                                                           |
| `/see_api_key`                            | Several Api keys now        |                                                                                                                                             |
| `/remind`                                 | Persona                     | Fixed reminder.                                                                                                                             |
| `/del_api_key` +key                       | Delete Api key              | Can follow multiple parameters, separated by spaces                                                                                         |
| `/add_api_key` +key                       | Add Api key                 | Can follow multiple parameters, separated by spaces                                                                                         |
| `/set_per_user_limit`                     | total user allocation limit | 1 is unlimited per user                                                                                                                     |
| `/set_per_hour_limit`                     | user hour usage             | 1 is unlimited, per user                                                                                                                    |
| `/reset_user_usage`+userID                | Reset user quota            | Measured by user Can be followed by multiple parameters, separated by spaces                                                                |
| `/promote_user_limit`+userID+limit        | Promote the user's limit    | Measured by user 1 is the default, can be followed by multiple parameters, separated by spaces                                              |

### Sample table

```markdown
chat - talk
write - completion
remind - character design
set_user_cold - set user cooldown
set_group_cold - set group cooldown
set_token_limit - set output limit length
set_input_limit - set input limit length
see_api_key - Several Api keys now
del_api_key - Delete Api key
add_api_key - add Api key
config - get/backup hot configuration file
set_per_user_limit - set normal user limit
set_per_hour_limit - set user hour limit
promote_user_limit - Promote user limit
reset_user_usage - Reset user usage
add_block_group - block group
del_block_group - Unblock group
add_block_user - block user
del_block_user - Unblock user
add_white_group - add whitelist group
add_white_user - add whitelist user
del_white_group - delist whitelist group
del_white_user - remove whitelist user
update_detect - update sensitive words
open_user_white_mode - open user whitelist
open_group_white_mode - open group whitelist
close_user_white_mode - close user whitelist
close_group_white_mode - close group whitelist
open - open the robot
close - close the robot
```

## other

### Statistics

``analysis.json`` is frequency statistics, the number of requests within 60s.

There is also total usage, which does not contain all usage data, but is just pulled from redis

### Config.json

Missing key values are automatically merged and repaired.

### Default parameters

- Group reply memory is 24 hours
- Quantity limited to 60000/h
- Context memory is 7
- The number of characters that trigger truncation is 3333x4 (api:max 4095x4) (tokenx4 roughly estimated)

### prompt_server.py

The Prompt clipping interface of peripherals provides support for other projects.

### 声明

```markdown
1. 此项目不是 Openai 的官方项目。
2. 不对机器人生成的任何内容负责
```


### QuickDev

Quick Dev by MVC framework https://github.com/TelechaBot/BaseBot